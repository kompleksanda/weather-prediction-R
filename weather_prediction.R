install.packages("devtools")
devtools::install_github("FinYang/tsdl")

library(tsdl)
library(gramEvol)
library(quantmod)


temperatures = subset(tsdl, description="Daily minimum temperatures in Melbourne")
autoplot(temperatures[[1]])
temperature_decomposed <- decompose(temperatures[[1]])
plot(temperature_decomposed)

arrivals = subset(tsdl, description="Passenger arrivals")
autoplot(arrivals[[1]])
arrival_series = ts(arrivals[[1]], frequency = 62)
arrival_decomposed <- decompose(arrival_series)
plot(arrival_decomposed)


temperatueradjusted <- temperatures - temperature_decomposed$seasonal

temperatueradjustedframe <- data.frame(x3=Lag(temperatueradjusted,3), x2=Lag(temperatueradjusted,2), x1=Lag(temperatueradjusted,1), temperatueradjusted)
names (temperatueradjustedframe) <- c('x3', 'x2', 'x1', 'x')


traindata <- temperatueradjustedframe[1:800,]
traindata 
testdata <- temperatueradjustedframe[801:1000,]

#define the grammar

newRules <- list(expr = grule(op(expr, expr), func(expr), var),
                 func = grule(sin, cos, exp, log),
                 op = grule('+', '-', '*', '/', '^'),
                 var = grule(mydata$x3, mydata$x2, mydata$x1))

# Then need to create grammar from rules
# Need to be clear about this step
newGram <- CreateGrammar(newRules)
newGram

# Fitness function (RMSE)
newFitFunc <- function(expr) {
  result <- eval(expr)
  if (any(is.nan(result)))
    return(Inf)
  return (sqrt(mean((mydata$x - result)^2)))
}



# Now use the training data to evolve a function to 
# predict values 5:20 based on values 1:4, 2:5, ... , 16:19
mydata <- traindata

# run it...
ge <- GrammaticalEvolution(newGram, newFitFunc, terminationCost = 0.1, iterations = 100, max.depth = 5)
# look at the outcome...
ge

# Get the result out
ge$best$expressions

# Look at the values generated by training
eval(ge$best$expressions)

# Then look at the performance over the test data
mydata <- testdata
eval(ge$best$expressions)


## Predicting more than one step ahead ##

# Now use this to make further predictions - i.e. use generated values rather than exiting ones

# grab the last 3 (or whaever your window size is) values from the training data
mydata <-temperatueradjustedframe[18,1:3]

# initiaise an array of predictions
predictions <-c()

# let's try and predict 5 values ahead, each time feeding in 
# the predicted value to use as input for new predictions

for(i in 1:5){
  predictions[i] <- eval(ge$best$expressions)
  # shufle data along and inser new prediction
  # put this in a loop for a large window size
  mydata[1] <- mydata[2] 
  mydata[2] <- mydata[3]
  mydata[3] <- predictions[i]}

# See what the predictions are
predictions

plot(predictions)
plot(temperatueradjustedframe)